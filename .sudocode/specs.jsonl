{"id":"s-6t4r","uuid":"c8d7bbdf-80cb-4f8c-8d74-6fce1085f8ba","title":"ACP Factory Library","file_path":"specs/s-6t4r_acp_factory_library.md","content":"# ACP Factory Library\n\nA TypeScript library for spawning and managing agents through the Agent Client Protocol (ACP).\n\n## Goal\n\nCreate a clean, minimal library that allows applications to:\n- Spawn coding agents (starting with Claude Code, eventually supporting Codex, Gemini, etc.)\n- Interact with agents through the standardized ACP protocol\n- Handle streaming responses, permissions, and file operations\n\n## Requirements\n\n### Functional Requirements\n\n1. **Agent Spawning**\n   - Spawn agent subprocesses (e.g., `claude-code-acp`)\n   - Establish ACP connection over stdin/stdout using NDJSON\n   - Initialize connection and negotiate capabilities\n\n2. **Session Management**\n   - Create new sessions with a working directory\n   - Load existing sessions by ID\n   - Support multiple concurrent sessions per agent\n\n3. **Prompt/Response Flow**\n   - Send prompts (text, images, resources)\n   - Receive streaming session updates via async iterators\n   - Handle all update types: `agent_message_chunk`, `tool_call`, `tool_call_update`, `plan`, etc.\n\n4. **Permission Handling**\n   - Configurable permission callback\n   - Default to auto-approve (suitable for dev/trusted environments)\n   - Support auto-deny and require-callback modes\n\n5. **File Operations**\n   - Default to filesystem reads/writes\n   - Allow custom handlers for sandboxing\n\n6. **Provider Registry**\n   - Register agent configurations by name\n   - Pre-register Claude Code provider\n   - Extensible for future agents (Codex, Gemini)\n\n### Non-Functional Requirements\n\n- Minimal dependencies (only `@agentclientprotocol/sdk`)\n- Clean TypeScript types\n- Async-first design with proper cleanup\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Application                                        │\n│                                                     │\n│  const agent = await AgentFactory.spawn(\"claude\");  │\n│  const session = await agent.createSession(cwd);    │\n│  for await (const update of session.prompt(msg)) {} │\n└───────────────────────┬─────────────────────────────┘\n                        │\n┌───────────────────────▼─────────────────────────────┐\n│  acp-factory library                                │\n│                                                     │\n│  AgentFactory → AgentHandle → Session               │\n│                                                     │\n│  ACPClientHandler (implements acp.Client)           │\n│  - requestPermission() → callback/auto              │\n│  - sessionUpdate() → async iterator                 │\n│  - readTextFile/writeTextFile → fs/callback         │\n└───────────────────────┬─────────────────────────────┘\n                        │ stdin/stdout (NDJSON)\n┌───────────────────────▼─────────────────────────────┐\n│  Agent Subprocess (claude-code-acp, etc.)           │\n└─────────────────────────────────────────────────────┘\n```\n\n## Core API Design\n\n### AgentFactory\n```typescript\ninterface AgentConfig {\n  command: string;      // e.g., \"npx\"\n  args: string[];       // e.g., [\"claude-code-acp\"]\n  env?: Record<string, string>;\n}\n\nclass AgentFactory {\n  static register(name: string, config: AgentConfig): void;\n  static spawn(name: string, options?: SpawnOptions): Promise<AgentHandle>;\n}\n```\n\n### AgentHandle\n```typescript\nclass AgentHandle {\n  readonly capabilities: AgentCapabilities;\n  createSession(cwd: string, options?: SessionOptions): Promise<Session>;\n  loadSession(sessionId: string): Promise<Session>;\n  close(): Promise<void>;\n}\n```\n\n### Session\n```typescript\nclass Session {\n  readonly id: string;\n  readonly modes: string[];\n  readonly models: string[];\n  \n  prompt(content: PromptContent): AsyncIterable<SessionUpdate>;\n  cancel(): Promise<void>;\n  setMode(mode: string): Promise<void>;\n}\n```\n\n## Design Decisions\n\n1. **Async iterators for streaming** - `prompt()` returns `AsyncIterable<SessionUpdate>` for natural `for await...of` consumption\n\n2. **Configurable permissions with auto-approve default** - Suitable for development; can require explicit handler or auto-deny\n\n3. **Default file ops to fs** - Simple default; overridable for sandboxing\n\n4. **Pre-registered providers** - Claude Code registered by default; users can register others\n\n5. **Package name**: `acp-factory`\n\n## File Structure\n\n```\nsrc/\n├── index.ts              # Public exports\n├── types.ts              # Type definitions\n├── factory.ts            # AgentFactory\n├── agent-handle.ts       # AgentHandle\n├── session.ts            # Session\n├── client-handler.ts     # ACPClientHandler\n└── providers/\n    └── claude-code.ts    # Claude Code config\n```\n\n## Reference Implementations\n\n- ACP TypeScript SDK: `references/typescript-sdk/`\n- Claude Code ACP Adapter: `references/claude-code-acp/`\n","priority":1,"archived":0,"archived_at":null,"created_at":"2025-12-11 19:30:58","updated_at":"2025-12-11 19:30:58","parent_id":null,"parent_uuid":null,"relationships":[],"tags":["acp","agents","library","typescript"]}
