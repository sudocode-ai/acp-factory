{"id":"s-6t4r","uuid":"c8d7bbdf-80cb-4f8c-8d74-6fce1085f8ba","title":"ACP Factory Library","file_path":"specs/s-6t4r_acp_factory_library.md","content":"# ACP Factory Library\n\nA TypeScript library for spawning and managing agents through the Agent Client Protocol (ACP).\n\n## Goal\n\nCreate a clean, minimal library that allows applications to:\n- Spawn coding agents (starting with Claude Code, eventually supporting Codex, Gemini, etc.)\n- Interact with agents through the standardized ACP protocol\n- Handle streaming responses, permissions, and file operations\n\n## Requirements\n\n### Functional Requirements\n\n1. **Agent Spawning**\n   - Spawn agent subprocesses (e.g., `claude-code-acp`)\n   - Establish ACP connection over stdin/stdout using NDJSON\n   - Initialize connection and negotiate capabilities\n\n2. **Session Management**\n   - Create new sessions with a working directory\n   - Load existing sessions by ID\n   - Support multiple concurrent sessions per agent\n\n3. **Prompt/Response Flow**\n   - Send prompts (text, images, resources)\n   - Receive streaming session updates via async iterators\n   - Handle all update types: `agent_message_chunk`, `tool_call`, `tool_call_update`, `plan`, etc.\n\n4. **Permission Handling**\n   - Configurable permission callback\n   - Default to auto-approve (suitable for dev/trusted environments)\n   - Support auto-deny and require-callback modes\n\n5. **File Operations**\n   - Default to filesystem reads/writes\n   - Allow custom handlers for sandboxing\n\n6. **Provider Registry**\n   - Register agent configurations by name\n   - Pre-register Claude Code provider\n   - Extensible for future agents (Codex, Gemini)\n\n### Non-Functional Requirements\n\n- Minimal dependencies (only `@agentclientprotocol/sdk`)\n- Clean TypeScript types\n- Async-first design with proper cleanup\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Application                                        │\n│                                                     │\n│  const agent = await AgentFactory.spawn(\"claude\");  │\n│  const session = await agent.createSession(cwd);    │\n│  for await (const update of session.prompt(msg)) {} │\n└───────────────────────┬─────────────────────────────┘\n                        │\n┌───────────────────────▼─────────────────────────────┐\n│  acp-factory library                                │\n│                                                     │\n│  AgentFactory → AgentHandle → Session               │\n│                                                     │\n│  ACPClientHandler (implements acp.Client)           │\n│  - requestPermission() → callback/auto              │\n│  - sessionUpdate() → async iterator                 │\n│  - readTextFile/writeTextFile → fs/callback         │\n└───────────────────────┬─────────────────────────────┘\n                        │ stdin/stdout (NDJSON)\n┌───────────────────────▼─────────────────────────────┐\n│  Agent Subprocess (claude-code-acp, etc.)           │\n└─────────────────────────────────────────────────────┘\n```\n\n## Core API Design\n\n### AgentFactory\n```typescript\ninterface AgentConfig {\n  command: string;      // e.g., \"npx\"\n  args: string[];       // e.g., [\"claude-code-acp\"]\n  env?: Record<string, string>;\n}\n\nclass AgentFactory {\n  static register(name: string, config: AgentConfig): void;\n  static spawn(name: string, options?: SpawnOptions): Promise<AgentHandle>;\n}\n```\n\n### AgentHandle\n```typescript\nclass AgentHandle {\n  readonly capabilities: AgentCapabilities;\n  createSession(cwd: string, options?: SessionOptions): Promise<Session>;\n  loadSession(sessionId: string): Promise<Session>;\n  close(): Promise<void>;\n}\n```\n\n### Session\n```typescript\nclass Session {\n  readonly id: string;\n  readonly modes: string[];\n  readonly models: string[];\n  \n  prompt(content: PromptContent): AsyncIterable<SessionUpdate>;\n  cancel(): Promise<void>;\n  setMode(mode: string): Promise<void>;\n}\n```\n\n## Design Decisions\n\n1. **Async iterators for streaming** - `prompt()` returns `AsyncIterable<SessionUpdate>` for natural `for await...of` consumption\n\n2. **Configurable permissions with auto-approve default** - Suitable for development; can require explicit handler or auto-deny\n\n3. **Default file ops to fs** - Simple default; overridable for sandboxing\n\n4. **Pre-registered providers** - Claude Code registered by default; users can register others\n\n5. **Package name**: `acp-factory`\n\n## File Structure\n\n```\nsrc/\n├── index.ts              # Public exports\n├── types.ts              # Type definitions\n├── factory.ts            # AgentFactory\n├── agent-handle.ts       # AgentHandle\n├── session.ts            # Session\n├── client-handler.ts     # ACPClientHandler\n└── providers/\n    └── claude-code.ts    # Claude Code config\n```\n\n## Reference Implementations\n\n- ACP TypeScript SDK: `references/typescript-sdk/`\n- Claude Code ACP Adapter: `references/claude-code-acp/`\n","priority":1,"archived":0,"archived_at":null,"created_at":"2025-12-11 19:30:58","updated_at":"2025-12-11 19:30:58","parent_id":null,"parent_uuid":null,"relationships":[],"tags":["acp","agents","library","typescript"]}
{"id":"s-5crl","uuid":"30e92cd7-42fe-46aa-abfe-cfc18f42685e","title":"Sandbox Support for claude-code-acp-fork","file_path":"specs/s-5crl_sandbox_support_for_claude_code_acp_fork.md","content":"# Sandbox Support for claude-code-acp-fork\n\n## Overview\n\nAdd OS-level sandboxing to the forked `claude-code-acp` agent using Anthropic's `@anthropic-ai/sandbox-runtime` package. This enables the agent to self-sandbox, restricting filesystem and network access for all operations it performs.\n\n## Goals\n\n1. **Security**: Prevent the agent from accessing unauthorized files or network domains\n2. **Reduced friction**: Auto-allow bash commands when sandboxed (fewer permission prompts)\n3. **Configurability**: Allow clients to specify sandbox settings per-session via ACP protocol\n4. **Visibility**: Surface sandbox violations to clients for transparency\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│  Client (acp-factory)                                       │\n│  - Passes sandbox config via initialize() _meta             │\n└─────────────────────┬───────────────────────────────────────┘\n                      │ ACP JSON-RPC\n                      ▼\n┌─────────────────────────────────────────────────────────────┐\n│  claude-code-acp-fork                                       │\n│  ┌───────────────────────────────────────────────────────┐  │\n│  │ SandboxManager.initialize(config)                     │  │\n│  │   ├── Filesystem: denyRead, allowWrite, denyWrite     │  │\n│  │   └── Network: allowedDomains, deniedDomains          │  │\n│  └───────────────────────────────────────────────────────┘  │\n│  ┌───────────────────────────────────────────────────────┐  │\n│  │ All operations now sandboxed:                         │  │\n│  │   - Bash tool → restricted shell execution            │  │\n│  │   - File operations → path restrictions enforced      │  │\n│  │   - Network → proxy-based domain filtering            │  │\n│  └───────────────────────────────────────────────────────┘  │\n└─────────────────────────────────────────────────────────────┘\n```\n\n## Configuration Schema\n\n### SandboxConfig (passed via ACP `_meta`)\n\n```typescript\ninterface SandboxConfig {\n  /** Enable sandbox enforcement */\n  enabled: boolean;\n  \n  /** Auto-allow Bash commands when sandboxed (reduces prompts) */\n  autoAllowBashIfSandboxed?: boolean;\n  \n  /** Network restrictions */\n  network?: {\n    /** Domains the agent can access (supports wildcards like *.github.com) */\n    allowedDomains?: string[];\n    /** Domains to explicitly block (overrides allowedDomains) */\n    deniedDomains?: string[];\n  };\n  \n  /** Filesystem restrictions */\n  filesystem?: {\n    /** Paths to deny read access (glob patterns) */\n    denyRead?: string[];\n    /** Paths to allow write access (default: cwd only) */\n    allowWrite?: string[];\n    /** Paths to explicitly deny write access */\n    denyWrite?: string[];\n  };\n}\n```\n\n### Example Configuration\n\n```typescript\n{\n  enabled: true,\n  autoAllowBashIfSandboxed: true,\n  network: {\n    allowedDomains: [\n      'npmjs.org',\n      '*.npmjs.org',\n      'github.com',\n      '*.githubusercontent.com',\n      'registry.yarnpkg.com',\n    ],\n    deniedDomains: [],\n  },\n  filesystem: {\n    denyRead: [\n      '~/.ssh/**',\n      '~/.aws/**',\n      '~/.config/gh/**',\n      '.env',\n      '.env.*',\n      '**/*.pem',\n      '**/credentials*',\n    ],\n    allowWrite: ['.', '/tmp'],\n    denyWrite: ['.env', '.env.*', '**/*.pem'],\n  },\n}\n```\n\n## Implementation Plan\n\n### Phase 1: Core Sandbox Integration\n\n#### 1.1 Add dependency\n- Add `@anthropic-ai/sandbox-runtime` to package.json dependencies\n\n#### 1.2 Create `src/sandbox.ts`\n- Define `SandboxConfig` TypeScript interface\n- Create `toSandboxRuntimeConfig()` converter function\n- Export utility functions for sandbox state management\n\n#### 1.3 Modify `src/acp-agent.ts`\n- Add sandbox state to `ClaudeAcpAgent` class:\n  - `private sandboxConfig?: SandboxConfig`\n  - `private sandboxInitialized: boolean = false`\n- Extract sandbox config from `initialize()` params `_meta.sandbox`\n- Call `SandboxManager.initialize()` when enabled\n- Add `isSandboxed()` method for querying state\n- Add cleanup in agent shutdown\n\n### Phase 2: Permission Integration\n\n#### 2.1 Modify `src/settings.ts`\n- Add `shouldAutoAllowWhenSandboxed()` function\n- Check `autoAllowBashIfSandboxed` flag for Bash tool calls\n\n#### 2.2 Update permission flow in `src/acp-agent.ts`\n- Integrate auto-allow logic into `canUseTool()` callback\n- When sandboxed + `autoAllowBashIfSandboxed`: return `true` for Bash\n\n### Phase 3: Violation Reporting\n\n#### 3.1 Subscribe to violations\n- Use `SandboxViolationStore.onViolation()` callback\n- Log violations via agent's logger\n\n#### 3.2 Surface to client (optional enhancement)\n- Emit sandbox violations as session updates\n- Define new `sessionUpdate` type: `sandbox_violation`\n\n### Phase 4: Testing\n\n#### 4.1 Unit tests (`src/tests/sandbox.test.ts`)\n- Test config conversion functions\n- Test auto-allow logic\n\n#### 4.2 Integration tests\n- Test sandbox initialization\n- Test that violations are detected (mock or real)\n\n## Files to Create/Modify\n\n| File | Action | Description |\n|------|--------|-------------|\n| `package.json` | Modify | Add `@anthropic-ai/sandbox-runtime` dependency |\n| `src/sandbox.ts` | Create | Sandbox types and utilities |\n| `src/acp-agent.ts` | Modify | Initialize sandbox, manage state |\n| `src/settings.ts` | Modify | Auto-allow logic for sandboxed bash |\n| `src/tests/sandbox.test.ts` | Create | Unit tests for sandbox module |\n\n## Platform Requirements\n\n- **macOS**: Uses Seatbelt (built-in, no extra install)\n- **Linux**: Requires `bubblewrap` package (`apt install bubblewrap`)\n- **Windows**: Not supported (sandbox-runtime limitation)\n\n## Security Considerations\n\n1. **Deny-first for writes**: Only explicitly allowed paths can be written\n2. **Allow-first for reads**: All reads allowed unless explicitly denied\n3. **Network proxy**: All traffic routed through local proxy for filtering\n4. **No escape hatch by default**: Unlike Claude Code CLI, no `dangerouslyDisableSandbox`\n\n## Open Questions\n\n1. Should we expose `excludedCommands` (commands that bypass sandbox)?\n2. Should violation reporting be opt-in or always-on?\n3. Should we support per-tool sandbox config (e.g., different network rules for WebFetch)?\n\n## Success Criteria\n\n- [ ] Agent can be initialized with sandbox config via ACP\n- [ ] Bash commands are sandboxed (filesystem + network restrictions apply)\n- [ ] Auto-allow reduces permission prompts when sandboxed\n- [ ] Violations are logged and optionally surfaced to client\n- [ ] Tests pass on macOS and Linux","priority":1,"archived":1,"archived_at":"2025-12-16T23:30:09.004Z","created_at":"2025-12-12 19:04:06","updated_at":"2025-12-16 23:30:09","parent_id":null,"parent_uuid":null,"relationships":[],"tags":["claude-code-acp","feature","sandbox","security"]}
{"id":"s-948y","uuid":"d60c54e6-ced3-4719-a497-e820bb0567c9","title":"Session Forking Support for claude-code-acp-fork","file_path":"specs/s-948y_session_forking_support_for_claude_code_acp_fork.md","content":"# Session Forking Support for claude-code-acp-fork\n\n## Overview\n\nImplement the ACP `session/fork` method in claude-code-acp to allow clients to create new independent sessions from existing ones. This enables branching conversations, creating checkpoints, and generating summaries without affecting the original session history.\n\n## Background\n\n### ACP Protocol Support\n\nThe ACP protocol defines `session/fork` as an experimental method:\n\n```typescript\ntype ForkSessionRequest = {\n  sessionId: SessionId;  // Session to fork from\n  cwd: string;           // Working directory for new session\n  mcpServers?: McpServer[];\n  _meta?: Record<string, unknown>;\n};\n\ntype ForkSessionResponse = {\n  sessionId: SessionId;  // New forked session ID\n  modes?: SessionModeState;\n  models?: SessionModelState;\n  configOptions?: SessionConfigOption[];\n};\n```\n\n### Claude Agent SDK Support\n\nThe SDK supports forking via combination of options:\n\n```typescript\nconst options: Options = {\n  resume: existingSessionId,  // Session to fork from\n  forkSession: true,          // Create new ID instead of continuing\n  resumeSessionAt?: string,   // Optional: fork from specific message\n};\n```\n\n## Use Cases\n\n1. **Branching conversations** - Try different approaches without losing original context\n2. **Checkpointing** - Save state before risky operations\n3. **Summaries** - Generate summaries in isolated sessions\n4. **Parallel exploration** - Explore multiple solutions simultaneously\n\n## Implementation\n\n### 1. Advertise Capability\n\nModify the `initialize()` response to include fork capability:\n\n```typescript\n// In acp-agent.ts initialize() method\nreturn {\n  protocolVersion: 1,\n  agentCapabilities: {\n    sessionCapabilities: {\n      fork: {},  // Empty object signals support\n    },\n    promptCapabilities: {\n      image: true,\n      embeddedContext: true,\n    },\n    mcpCapabilities: {\n      http: true,\n      sse: true,\n    },\n  },\n  // ... rest of response\n};\n```\n\n### 2. Implement unstable_forkSession Method\n\nAdd to `ClaudeAcpAgent` class:\n\n```typescript\nasync unstable_forkSession(\n  params: ForkSessionRequest\n): Promise<ForkSessionResponse> {\n  const { sessionId, cwd, mcpServers, _meta } = params;\n\n  // Verify source session exists\n  if (!this.sessions[sessionId]) {\n    throw RequestError.invalidParams(`Session ${sessionId} not found`);\n  }\n\n  // Create new session with fork options\n  const newSessionResponse = await this.newSession({\n    cwd,\n    mcpServers,\n    _meta: {\n      ...(_meta || {}),\n      claudeCode: {\n        options: {\n          resume: sessionId,\n          forkSession: true,\n          // Optionally support forking from specific message\n          ...(_meta?.claudeCode?.options || {}),\n        },\n      },\n    },\n  });\n\n  return {\n    sessionId: newSessionResponse.sessionId,\n    modes: newSessionResponse.modes,\n    models: newSessionResponse.models,\n    configOptions: newSessionResponse.configOptions,\n  };\n}\n```\n\n### 3. Import Required Types\n\n```typescript\nimport {\n  ForkSessionRequest,\n  ForkSessionResponse,\n  // ... existing imports\n} from \"@agentclientprotocol/sdk\";\n```\n\n## Extended Features (Optional)\n\n### Fork from Specific Message\n\nSupport `resumeSessionAt` to fork from a specific point in conversation:\n\n```typescript\n// In _meta\n{\n  claudeCode: {\n    options: {\n      resumeSessionAt: \"message-uuid-here\"\n    }\n  }\n}\n```\n\n### Fork with Modified Context\n\nAllow clients to modify system prompt or settings in forked session:\n\n```typescript\n// In _meta\n{\n  systemPrompt: { append: \"Focus on summarizing.\" },\n  claudeCode: {\n    options: {\n      // fork options\n    }\n  }\n}\n```\n\n## Files to Modify\n\n| File | Changes |\n|------|---------|\n| `src/acp-agent.ts` | Add `unstable_forkSession` method, update capabilities |\n\n## Testing\n\n### Unit Tests\n\n```typescript\ndescribe(\"unstable_forkSession\", () => {\n  it(\"creates new session from existing one\", async () => {\n    // Create original session\n    const original = await agent.newSession({ cwd: \"/tmp\" });\n    \n    // Fork it\n    const forked = await agent.unstable_forkSession({\n      sessionId: original.sessionId,\n      cwd: \"/tmp\",\n    });\n    \n    // Verify different session IDs\n    expect(forked.sessionId).not.toBe(original.sessionId);\n  });\n\n  it(\"throws error for non-existent session\", async () => {\n    await expect(\n      agent.unstable_forkSession({\n        sessionId: \"non-existent\",\n        cwd: \"/tmp\",\n      })\n    ).rejects.toThrow();\n  });\n\n  it(\"preserves conversation context in forked session\", async () => {\n    // Create and interact with original session\n    const original = await agent.newSession({ cwd: \"/tmp\" });\n    await agent.prompt({ sessionId: original.sessionId, prompt: \"Remember X=42\" });\n    \n    // Fork and verify context preserved\n    const forked = await agent.unstable_forkSession({\n      sessionId: original.sessionId,\n      cwd: \"/tmp\",\n    });\n    \n    // Query forked session about X\n    const response = await agent.prompt({ \n      sessionId: forked.sessionId, \n      prompt: \"What is X?\" \n    });\n    // Response should reference X=42\n  });\n});\n```\n\n## Success Criteria\n\n- [ ] Agent advertises `sessionCapabilities.fork` capability\n- [ ] `unstable_forkSession` method implemented\n- [ ] Forked sessions have independent session IDs\n- [ ] Forked sessions preserve conversation context from source\n- [ ] Modifications to forked session don't affect original\n- [ ] Error handling for non-existent source sessions\n- [ ] Unit tests pass","priority":1,"archived":0,"archived_at":null,"created_at":"2025-12-16 23:31:55","updated_at":"2025-12-16 23:31:55","parent_id":null,"parent_uuid":null,"relationships":[],"tags":["claude-code-acp","feature","forking","session"]}
